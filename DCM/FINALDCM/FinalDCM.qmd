---
title: "Assignment 4 DCM - Voting Biden or Trump in the 2024 US Presidential Elections"
author: "Marc Sparhuber"
format: pdf
editor: source
execute:
  warning: false
  echo: false
toc: true
header-includes:
      - \usepackage{float}
      - \floatplacement{table}{H}
---

\newpage 

```{r}
library(tidyverse)
library(tidymodels)
library(survival)
library(kableExtra)
library(gtsummary)
library(haven)

og_data <- read_dta(here::here("DCM","FINALDCM", "acs_2015.dta"))

og_data$degfield <- labelled::to_factor(og_data$degfield)
og_data$degfieldd <- labelled::to_factor(og_data$degfieldd)
og_data$degfield2 <- labelled::to_factor(og_data$degfield2)
og_data$degfield2d <- labelled::to_factor(og_data$degfield2d)
og_data$empstat <- labelled::to_factor(og_data$empstat)
og_data$rachsing <- labelled::to_factor(og_data$rachsing)
og_data$stateicp <- labelled::to_factor(og_data$stateicp)
og_data$met2013 <- labelled::to_factor(og_data$met2013)
og_data$bpld <- labelled::to_factor(og_data$bpld)
og_data$bpl <- labelled::to_factor(og_data$bpl)
og_data$occ <- labelled::to_factor(og_data$occ)
og_data$citizen <- labelled::to_factor(og_data$citizen)
```

```{r}
data <- og_data |> select(sex,age,stateicp,met2013,birthyr,bpl,citizen,yrimmig,
                          yrsusa1,rachsing,educd,degfield,empstat,uhrswork,inctot,incearn,poverty)

#drop na level in degree so it doesn't get annoying later
data$degfield <- fct_recode(data$degfield, NULL = "N/A")
data$citizen <- fct_recode(data$citizen, "Citizen" = "N/A")
data$empstat <- fct_recode(data$empstat, NULL = "N/A")

# reduce to people who have done a bachelors at least - they will be the observed group
data <- data |> filter(educd > 101 & educd != 999)

# make new variable to get age at migration and take a look at my group of interest
data <- data |> mutate(
   age_at_immigration = if_else(yrimmig != 0, yrimmig - (2015-age), NA_integer_),
   young_migrant = if_else(!is.na(age_at_immigration) & age_at_immigration >= 0 & age_at_immigration <= 21, "YM", "Not YM"),
   young_migrant = as_factor(young_migrant)
   ) |> 
  filter(birthyr >= 1960)
  # |> filter(birthyr > 1960 & !is.na(age_at_immigration) & age_at_immigration >= 0 & age_at_immigration <= 21) |> View()
# cho0sing born earliest 1960 because then the full range of possible degrees would have likely been available: 13,777 YM



# make a little summarize table
interesting_data_smile <- data |>
  group_by(degfield) |> 
  filter(n()>=1000) |> 
  summarise(
    n_degree_holders = n(),
    med_age = median(age),
    n_women = sum(sex==2),
    p_women = sum(sex==2)/n(),
    n_young_migrants = sum(!is.na(age_at_immigration) & age_at_immigration >= 0 & age_at_immigration <= 21),
    p_young_migrants = sum(!is.na(age_at_immigration) & age_at_immigration >= 0 & age_at_immigration <= 21)/n(),
    n_employed = sum(empstat == "Employed"),
    p_employed = sum(empstat == "Employed")/n(),
    n_ym_employed = sum(empstat == "Employed" & !is.na(age_at_immigration) & age_at_immigration >= 0 & age_at_immigration <= 21),
    p_ym_employed_within = sum(empstat == "Employed" & !is.na(age_at_immigration) & age_at_immigration >= 0 & age_at_immigration <= 21)/n_young_migrants,
    p_ym_employed_general = sum(empstat == "Employed" & !is.na(age_at_immigration) & age_at_immigration >= 0 & age_at_immigration <= 21)/n(),
    mean_weekly_hours = round(mean(uhrswork),2),
    med_tot_income = median(inctot),
    med_earned_income = median(incearn),
    mean_poverty = round(mean(poverty),2)
    )


#so there are no too small categories blah
interesting_data_smile$degfield <- droplevels(interesting_data_smile$degfield)

# id part!
set.seed(1)
sample_degree_holders <- data |> filter(degfield %in% interesting_data_smile$degfield)
sample_degree_holders$degfield <- fct_drop(sample_degree_holders$degfield)

sample_degree_holders <- sample_degree_holders |> 
group_by(young_migrant) |> 
  slice_sample(n = 10000) |> ungroup() |> mutate(ID = row_number())

size <- 10
alts <- interesting_data_smile$degfield

sample_degree_holders |> 
  ungroup() |> 
  select(ID) |>  
  mutate(alt = replicate(n(), sample(alts, size = size, replace = FALSE), simplify = FALSE)) |> 
  unnest(alt) |>
  anti_join(sample_degree_holders, by = join_by(ID, alt == degfield)) |> 
  group_by(ID) |> slice(1:(size-1)) ->
  degree_choice


# reduce variables in degree table for conditional logit
interesting_data_smile2 <- interesting_data_smile 
#|> select(-c(starts_with("n_"),starts_with("p_"),med_age))


sample_degree_holders |> 
  select(ID, alt = degfield) |>
  bind_rows(degree_choice) |> 
  group_by(ID) |> 
  arrange(ID, alt) |> 
  left_join(sample_degree_holders, by = join_by(ID)) |> 
  left_join(interesting_data_smile2, by = join_by(alt == degfield)) |> 
  mutate(choice = degfield == alt,
         choice = as.numeric(choice)) |> 
  select(-c(yrimmig,yrsusa1,met2013,educd,degfield,stateicp,bpl,age_at_immigration)) -> degree_choice2

# Sanity check good
sum(degree_choice2$choice) == nrow(sample_degree_holders)
sum(degree_choice2$choice)*size == nrow(degree_choice2)

library(survival)

degree_choice3 <- degree_choice2 |> select(ID, choice, rachsing, alt, young_migrant)


# why does one work an the other doesn't?
# https://stats.stackexchange.com/questions/377997/na-coefficients-produced-by-clogit-model
this_works <- clogit(choice ~ mean_weekly_hours + mean_poverty+ med_earned_income + alt + strata(ID), data = degree_choice2)
tidy(this_works) |> View()

this_doesnt_work <- clogit(choice ~ I(alt:young_migrant) + mean_weekly_hours + mean_poverty + med_earned_income + strata(ID), data = degree_choice2)
tidy(this_doesnt_work) |> View()



degree_choice2 %>%
  group_by(alt) %>%
  summarize(Num_Unique_Values = n_distinct(uhrswork)) |> View()



# only person characteristics -> does not work
person_only <- clogit(choice ~ I(as.numeric(uhrswork)) + strata(ID), data = degree_choice2)
tidy(person_only) |> View()



# filtered stuff
ym <- clogit(choice ~ mean_weekly_hours + mean_poverty+ med_earned_income + alt + strata(ID) ,
       data = filter(degree_choice2, young_migrant == "YM"))
tidy(ym) |> View()

t1 <- tbl_regression(ym, exponentiate = TRUE) |> 
  modify_header(list(label="**Covariate**",
                     estimate="**Odds**")) |>
  modify_footnote(update = list(estimate ~ NA), 
                  abbreviation=TRUE)
t1

nym <- clogit(choice ~  mean_weekly_hours + mean_poverty+ med_earned_income + alt + strata(ID) ,
       data = filter(degree_choice2, young_migrant == "Not YM"))
tidy(nym) |> View()

t2 <- tbl_regression(nym, exponentiate = TRUE) |> 
  modify_header(list(label="**Covariate**",
                     estimate="**Odds**")) |>
  modify_footnote(update = list(estimate ~ NA), 
                  abbreviation=TRUE)
t2

# OKAY SO BIG REVEWLATION:
# dont include alt duh
# only look at what makes the choice, not the choice itself
# these models often don't work cause the multicol from including the alts itself

#who do I want to look at:
# people who immigrated to the US in their childhood.
# born abroad
# have citizenship
# have got a college degree
# what field did they choose
```

